<!-- guard-app.html : 경비실 QR 인식 및 혈압/음주 결과 입력(모바일 우선, 단일 파일)
  사용법: 로컬에서 더블클릭 실행. 카메라 권한 허용 → QR 인식 또는 수동 입력.
  팔레트: --c-bg #ffffff, --c-accent #3EDB86, --c-ink #0A1E2E
  폰트: Nanum Gothic(네트워크 불가 시 시스템 폴백)
  접근성: aria/role/포커스 표시, 키보드 지원
  데이터 매핑(데모):
    - 'TEST1103' → { name:'김철수', work:'메트로씨앤씨, 안전난간 설치공사' }
  개인정보: 데모/로컬 전용, 서버 통신 없음. -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>경비실 QR 인식 · 혈압/음주 입력</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--c-bg:#ffffff;--c-accent:#3EDB86;--c-ink:#0A1E2E}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:"Nanum Gothic",system-ui,Arial,sans-serif;background:var(--c-bg);color:var(--c-ink)}
    .wrap{max-width:640px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
    .brand{font-weight:700}
    .btn{border:0;border-radius:12px;padding:12px 14px;background:var(--c-accent);color:#0A1E2E;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-outline{background:#fff;border:1px solid #e7e7e7;color:var(--c-ink);border-radius:12px;padding:10px 12px}
    :focus-visible{outline:2px solid var(--c-accent);outline-offset:2px}
    .card{border:1px solid #e7e7e7;border-radius:14px;padding:14px;margin:12px 0;background:#fff}
    .muted{font-size:12px;opacity:.75}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:8px}
    .status-badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid transparent}
    .ok{background:#e8fff2;border-color:#bfead2}
    .warn{background:#fff7e6;border-color:#ffe1a8}
    .error{background:#ffe8e8;border-color:#ffc6c6}
    .inline-note{padding:10px;border-left:4px solid var(--c-accent);background:#f8fffb;border-radius:10px}
    .qrbox{display:flex;align-items:center;justify-content:center;border:1px dashed #cbd5e1;border-radius:12px;min-height:220px;background:#fff}
    input[type="number"],input[type="text"]{width:100%;padding:10px;border:1px solid #e7e7e7;border-radius:10px}
    .scanner-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .scanner{background:#fff;border-radius:14px;padding:12px;width:100%;max-width:520px}
    .scanner video{width:100%;border-radius:10px;background:#000;aspect-ratio:3/4}
    .toast{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#0A1E2E;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;z-index:1100;display:none}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="경비실 QR 인식 화면">
    <header>
      <div class="brand">GS칼텍스 인천물류센터 · 경비실</div>
      <span class="status-badge ok">오프라인 데모</span>
    </header>

    <section class="card" role="region" aria-labelledby="h-title">
      <h1 id="h-title" style="margin:0 0 6px 0">QR 인식 · 혈압/음주 입력</h1>
      <p class="inline-note" style="font-weight:700;font-size:16px">QR 인식하기 → 결과 확인 → 혈압·음주 입력 → 확인</p>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="scanBtn" aria-label="QR 인식하기">QR 인식하기</button>
        <button class="btn-outline" id="manualToggle" aria-label="수동 입력 전환">수동 입력</button>
      </div>

      <!-- 수동 입력 박스 -->
      <div id="manualBox" class="row" style="margin-top:8px;display:none">
        <input id="manualCode" type="text" inputmode="latin" placeholder="코드 입력 (예: TEST1103)" aria-label="QR 코드 수동 입력">
        <button class="btn-outline" id="applyManual">적용</button>
      </div>
    </section>

    <!-- 결과 카드 -->
    <section class="card" role="region" aria-labelledby="h-result">
      <h2 id="h-result" style="margin:0 0 8px 0">인식 결과</h2>
      <div class="row" style="gap:10px">
        <span id="authBadge" class="status-badge muted" aria-live="polite">대기</span>
        <div class="muted">코드: <strong id="codeText">-</strong></div>
      </div>
      <div style="margin-top:6px">
        <div><strong>이름:</strong> <span id="nameText">-</span></div>
        <div><strong>공사명:</strong> <span id="workText">-</span></div>
      </div>
      <div id="denyBox" class="inline-note" style="display:none;margin-top:8px;background:#fff5f5;border-left-color:#ff6b6b">
        해당 출입자는 <strong>공사 출입 허가를 받지 못한 사람</strong>입니다.
      </div>
    </section>

    <!-- 입력 카드 -->
    <section class="card" role="region" aria-labelledby="h-inputs">
      <h2 id="h-inputs" style="margin:0 0 8px 0">혈압 · 음주 결과 입력</h2>
      <div class="grid">
<label class="row" style="justify-content:space-between">
  <span style="min-width:130px">최고 혈압(수축기, mmHg)</span>
  <input id="bpMax" type="number" min="0" max="300" placeholder="예: 120" aria-label="최고 혈압(수축기)">
</label>
<label class="row" style="justify-content:space-between">
  <span style="min-width:130px">최저 혈압(이완기, mmHg)</span>
  <input id="bpMin" type="number" min="0" max="200" placeholder="예: 80" aria-label="최저 혈압(이완기)">
</label>
        <div class="row" style="gap:6px">
          <input id="alcOver" type="checkbox" aria-label="음주 수치 초과">
          <label for="alcOver">음주 수치 초과</label>
        </div>
        <div class="row" style="gap:8px">
          <span class="muted">상태:</span>
          <span id="stateBadge" class="status-badge">대기</span>
          <span id="bpWarn" class="status-badge warn" style="display:none">주의: 150 이상</span>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="btn" id="confirmBtn" disabled aria-label="확인하여 담당자 알림">확인(담당자 알림)</button>
      </div>
    </section>

  </div>

  <!-- 스캐너 오버레이 -->
  <div class="scanner-overlay" id="scannerLayer" aria-hidden="true">
    <div class="scanner" role="dialog" aria-label="QR 스캐너">
      <video id="qrVideo" playsinline autoplay muted></video>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="btn-outline" id="closeScanner">닫기</button>
      </div>
      <p class="muted">카메라가 보이지 않으면 권한을 허용하거나 수동 입력을 사용하세요.</p>
    </div>
  </div>

  <!-- 토스트 -->
  <div class="toast" id="toast" role="status" aria-live="polite">담당자에게 알림을 전송했습니다.</div>

  <script>
    // ===== 데모 레지스트리: QR 코드 → 출입자 정보 매핑 =====
    const registry = {
      'TEST1103': { name: '김철수', work: '메트로씨앤씨, 안전난간 설치공사' }
    };

    // ===== 엘리먼트 =====
    const scanBtn = document.getElementById('scanBtn');
    const manualToggle = document.getElementById('manualToggle');
    const manualBox = document.getElementById('manualBox');
    const manualCode = document.getElementById('manualCode');
    const applyManual = document.getElementById('applyManual');

    const authBadge = document.getElementById('authBadge');
    const codeText = document.getElementById('codeText');
    const nameText = document.getElementById('nameText');
    const workText = document.getElementById('workText');
    const denyBox = document.getElementById('denyBox');

const bpMax = document.getElementById('bpMax');
const bpMin = document.getElementById('bpMin');
    const bpWarn = document.getElementById('bpWarn');
    const alcOver = document.getElementById('alcOver');
    const stateBadge = document.getElementById('stateBadge');
    const confirmBtn = document.getElementById('confirmBtn');

    const scannerLayer = document.getElementById('scannerLayer');
    const closeScanner = document.getElementById('closeScanner');
    const qrVideo = document.getElementById('qrVideo');
    const toast = document.getElementById('toast');

    // ===== 상태 =====
    let mediaStream = null;
    let scanning = false;
    let detector = null;
    let currentCode = null;   // 마지막 인식/입력 코드
    let authorized = false;   // 허가 여부

    // ===== UI 유틸 =====
    function setBadge(el, type, text){
      el.className = 'status-badge ' + (type||'');
      el.textContent = text;
    }
    function toastShow(msg){
      toast.textContent = msg || '알림을 전송했습니다.';
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 1600);
    }

    // ===== 결과 적용 =====
function applyResult(code){
  currentCode = (code || '').trim();
  codeText.textContent = currentCode || '-';

  // 레지스트리 조회 시 대소문자 무시
  const key = currentCode.toUpperCase();
  const rec = registry[key];
  authorized = !!rec;

  if(authorized){
    setBadge(authBadge, 'ok', '인증됨');
    nameText.textContent = rec.name;
    workText.textContent = rec.work;
    denyBox.style.display = 'none';
    confirmBtn.disabled = false;
  }else{
    setBadge(authBadge, 'error', '허가 미승인');
    nameText.textContent = '-';
    workText.textContent = '-';
    denyBox.style.display = 'block';
    confirmBtn.disabled = true;
  }
  updateEntryState();
}


    // ===== 상태 계산(혈압/음주) =====
  function updateEntryState(){
  // 최고/최저 파싱
  const maxVal = parseInt(bpMax.value, 10);
  const minVal = parseInt(bpMin.value, 10);
  const high = !isNaN(maxVal) && maxVal >= 150;

  // 경고 배지: 최고 150 이상일 때만 표시
  bpWarn.style.display = high ? 'inline-block' : 'none';

  if(!authorized){
    setBadge(stateBadge, 'error', '허가 미승인');
    return;
  }
  if(alcOver.checked){
    setBadge(stateBadge, 'error', '출입불가(음주)');
  }else if(high){
    setBadge(stateBadge, 'warn', '주의(혈압)');
  }else{
    setBadge(stateBadge, 'ok', '입장 가능');
  }
}


    // ===== 스캐너 =====
    async function openScanner(){
      scannerLayer.style.display = 'flex';
      scannerLayer.setAttribute('aria-hidden','false');
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},
          audio:false
        });
        qrVideo.srcObject = mediaStream;
        await qrVideo.play();
        startDetectLoop();
      }catch(e){
        alert('카메라를 사용할 수 없습니다. 수동 입력을 사용하세요.\n'+(e.message||e));
        closeScannerPane();
        manualBox.style.display = 'flex';
      }
    }
    function closeScannerPane(){
      scannerLayer.style.display = 'none';
      scannerLayer.setAttribute('aria-hidden','true');
      if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
      scanning = false;
    }
    async function startDetectLoop(){
      scanning = true;
      if('BarcodeDetector' in window){
        try{ detector = new BarcodeDetector({formats:['qr_code']}); }
        catch{ detector = null; }
      }
      if(!detector){
        alert('이 브라우저는 QR 인식을 지원하지 않습니다. 수동 입력을 사용하세요.');
        closeScannerPane();
        manualBox.style.display = 'flex';
        return;
      }
      (async function loop(){
        if(!scanning) return;
        try{
          const codes = await detector.detect(qrVideo);
          if(codes && codes.length){
            const txt = (codes[0].rawValue||'').trim();
            applyResult(txt);
            closeScannerPane();
            return;
          }
        }catch(e){ /* ignore and keep looping */ }
        requestAnimationFrame(loop);
      })();
    }

    // ===== 이벤트 =====
    scanBtn.addEventListener('click', openScanner);
    closeScanner.addEventListener('click', closeScannerPane);
    manualToggle.addEventListener('click', ()=>{
      manualBox.style.display = (manualBox.style.display==='flex' ? 'none' : 'flex');
    });
    applyManual.addEventListener('click', ()=> applyResult(manualCode.value));

bpMax.addEventListener('input', updateEntryState);
bpMin.addEventListener('input', updateEntryState);
    alcOver.addEventListener('change', updateEntryState);

    confirmBtn.addEventListener('click', ()=>{
      if(!authorized){ return; }
      // 실제 전송 대신 토스트로 모의
      toastShow('담당자에게 알림을 전송했습니다.');
      // 간단한 로그(콘솔)
      console.log('[ALERT]', {
        code: currentCode, name: nameText.textContent, work: workText.textContent,
        bp_sys: bpSys.value, alcohol_over: alcOver.checked, status: stateBadge.textContent
      });
    });

    // 초기 배지
    setBadge(authBadge, '', '대기');
    setBadge(stateBadge, '', '대기');
  </script>
</body>
</html>
