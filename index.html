<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>경비실 QR 인식 · 혈압/음주 입력</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--c-bg:#ffffff;--c-accent:#3EDB86;--c-ink:#0A1E2E}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:"Nanum Gothic",system-ui,Arial,sans-serif;background:var(--c-bg);color:var(--c-ink)}
    .wrap{max-width:640px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
    .brand{font-weight:700}
    .btn{border:0;border-radius:12px;padding:12px 14px;background:var(--c-accent);color:#0A1E2E;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-outline{background:#fff;border:1px solid #e7e7e7;color:var(--c-ink);border-radius:12px;padding:10px 12px}
    :focus-visible{outline:2px solid var(--c-accent);outline-offset:2px}
    .card{border:1px solid #e7e7e7;border-radius:14px;padding:14px;margin:12px 0;background:#fff}
    .muted{font-size:12px;opacity:.75}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:8px}
    .status-badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid transparent}
    .ok{background:#e8fff2;border-color:#bfead2}
    .warn{background:#fff7e6;border-color:#ffe1a8}
    .error{background:#ffe8e8;border-color:#ffc6c6}
    .inline-note{padding:10px;border-left:4px solid var(--c-accent);background:#f8fffb;border-radius:10px}
    .qrbox{display:flex;align-items:center;justify-content:center;border:1px dashed #cbd5e1;border-radius:12px;min-height:220px;background:#fff}
    input[type="number"],input[type="text"]{width:100%;padding:10px;border:1px solid #e7e7e7;border-radius:10px}
    .scanner-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .scanner{background:#fff;border-radius:14px;padding:12px;width:100%;max-width:520px}
    .scanner video{width:100%;border-radius:10px;background:#000;aspect-ratio:3/4}
    .toast{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#0A1E2E;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;z-index:1100;display:none}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="경비실 QR 인식 화면">
    <header>
      <div class="brand">GS칼텍스 인천물류센터 · 경비실</div>
      <span class="status-badge ok">오프라인 데모</span>
    </header>

    <section class="card" role="region" aria-labelledby="h-title">
      <h1 id="h-title" style="margin:0 0 6px 0">QR 인식 · 혈압/음주 입력</h1>
      <p class="inline-note" style="font-weight:700;font-size:16px">QR 인식하기 → 결과 확인 → 혈압·음주 입력 → 확인</p>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="scanBtn" aria-label="QR 인식하기">QR 인식하기</button>
        <button class="btn-outline" id="manualToggle" aria-label="수동 입력 전환">수동 입력</button>
      </div>

      <!-- 수동 입력 박스 -->
      <div id="manualBox" class="row" style="margin-top:8px;display:none">
        <input id="manualCode" type="text" inputmode="latin" placeholder="코드 입력 (예: TEST1103)" aria-label="QR 코드 수동 입력">
        <button class="btn-outline" id="applyManual">적용</button>
      </div>
    </section>

    <!-- 결과 카드 -->
    <section class="card" role="region" aria-labelledby="h-result">
      <h2 id="h-result" style="margin:0 0 8px 0">인식 결과</h2>
      <div class="row" style="gap:10px">
        <span id="authBadge" class="status-badge muted" aria-live="polite">대기</span>
        <div class="muted">코드: <strong id="codeText">-</strong></div>
      </div>
      <div style="margin-top:6px">
        <div><strong>이름:</strong> <span id="nameText">-</span></div>
        <div><strong>공사명:</strong> <span id="workText">-</span></div>
      </div>
      <div id="denyBox" class="inline-note" style="display:none;margin-top:8px;background:#fff5f5;border-left-color:#ff6b6b">
        해당 출입자는 <strong>공사 출입 허가를 받지 못한 사람</strong>입니다.
      </div>
    </section>

    <!-- 입력 카드 -->
    <section class="card" role="region" aria-labelledby="h-inputs">
      <h2 id="h-inputs" style="margin:0 0 8px 0">혈압 · 음주 결과 입력</h2>
      <div class="grid">
        <label class="row" style="justify-content:space-between">
          <span style="min-width:130px">최고 혈압(수축기, mmHg)</span>
          <input id="bpMax" type="number" min="0" max="300" placeholder="예: 120" aria-label="최고 혈압(수축기)">
        </label>
        <label class="row" style="justify-content:space-between">
          <span style="min-width:130px">최저 혈압(이완기, mmHg)</span>
          <input id="bpMin" type="number" min="0" max="200" placeholder="예: 80" aria-label="최저 혈압(이완기)">
        </label>
        <div class="row" style="gap:6px">
          <input id="alcOver" type="checkbox" aria-label="음주 수치 초과">
          <label for="alcOver">음주 수치 초과</label>
        </div>
        <div class="row" style="gap:8px">
          <span class="muted">상태:</span>
          <span id="stateBadge" class="status-badge">대기</span>
          <span id="bpWarn" class="status-badge warn" style="display:none">주의: 150 이상</span>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="btn" id="confirmBtn" disabled aria-label="확인하여 담당자 알림">확인(담당자 알림)</button>
      </div>
    </section>

    <!-- QR 미리보기(고정 텍스트: TEST1103) -->
    <section class="card" role="region" aria-labelledby="h-qr-preview">
      <h2 id="h-qr-preview" style="margin:0 0 8px 0">QR 미리보기 (TEST1103)</h2>
      <div class="qrbox" style="min-height:auto;padding:12px">
        <div id="qrcode" role="img" aria-label="TEST1103 QR 코드"></div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="btn-outline" id="saveQrBtn" aria-label="QR 이미지 저장">QR 저장(PNG)</button>
      </div>
      <p class="muted">스캐너가 인식하지 못하면 화면 밝기를 높이고, 가장자리 여백이 보이도록 출력하세요.</p>
    </section>

  </div>

  <!-- 스캐너 오버레이 -->
  <div class="scanner-overlay" id="scannerLayer" aria-hidden="true">
    <div class="scanner" role="dialog" aria-label="QR 스캐너">
      <video id="qrVideo" playsinline autoplay muted></video>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="btn-outline" id="closeScanner">닫기</button>
      </div>
      <p class="muted">카메라가 보이지 않으면 권한을 허용하거나 수동 입력을 사용하세요.</p>
    </div>
  </div>

  <!-- 토스트 -->
  <div class="toast" id="toast" role="status" aria-live="polite">담당자에게 알림을 전송했습니다.</div>

  <script>
    // ===== 데모 레지스트리: QR 코드 → 출입자 정보 매핑 =====
    const registry = {
      'TEST1103': { name: '김철수', work: '메트로씨앤씨, 안전난간 설치공사' }
    };

    // ===== 엘리먼트 =====
    const scanBtn = document.getElementById('scanBtn');
    const manualToggle = document.getElementById('manualToggle');
    const manualBox = document.getElementById('manualBox');
    const manualCode = document.getElementById('manualCode');
    const applyManual = document.getElementById('applyManual');

    const authBadge = document.getElementById('authBadge');
    const codeText = document.getElementById('codeText');
    const nameText = document.getElementById('nameText');
    const workText = document.getElementById('workText');
    const denyBox = document.getElementById('denyBox');

    const bpMax = document.getElementById('bpMax');
    const bpMin = document.getElementById('bpMin');
    const bpWarn = document.getElementById('bpWarn');
    const alcOver = document.getElementById('alcOver');
    const stateBadge = document.getElementById('stateBadge');
    const confirmBtn = document.getElementById('confirmBtn');

    const scannerLayer = document.getElementById('scannerLayer');
    const closeScanner = document.getElementById('closeScanner');
    const qrVideo = document.getElementById('qrVideo');
    const toast = document.getElementById('toast');

    // ===== 상태 =====
    let mediaStream = null;
    let scanning = false;
    let detector = null;
    let currentCode = null;   // 마지막 인식/입력 코드
    let authorized = false;   // 허가 여부

    // ===== UI 유틸 =====
    function setBadge(el, type, text){
      el.className = 'status-badge ' + (type||'');
      el.textContent = text;
    }
    function toastShow(msg){
      toast.textContent = msg || '알림을 전송했습니다.';
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 1600);
    }

    // ===== 결과 적용 =====
    function applyResult(code){
      currentCode = (code || '').trim();
      codeText.textContent = currentCode || '-';

      // 레지스트리 조회 시 대소문자 무시
      const key = currentCode.toUpperCase();
      const rec = registry[key];
      authorized = !!rec;

      if(authorized){
        setBadge(authBadge, 'ok', '인증됨');
        nameText.textContent = rec.name;
        workText.textContent = rec.work;
        denyBox.style.display = 'none';
        confirmBtn.disabled = false;
      }else{
        setBadge(authBadge, 'error', '허가 미승인');
        nameText.textContent = '-';
        workText.textContent = '-';
        denyBox.style.display = 'block';
        confirmBtn.disabled = true;
      }
      updateEntryState();
    }

    // ===== 상태 계산(혈압/음주) =====
    function updateEntryState(){
      const maxVal = parseInt(bpMax.value, 10);
      const minVal = parseInt(bpMin.value, 10);
      const high = !isNaN(maxVal) && maxVal >= 150;

      // 경고 배지: 최고 150 이상일 때만 표시
      bpWarn.style.display = high ? 'inline-block' : 'none';

      if(!authorized){
        setBadge(stateBadge, 'error', '허가 미승인');
        return;
      }
      if(alcOver.checked){
        setBadge(stateBadge, 'error', '출입불가(음주)');
      }else if(high){
        setBadge(stateBadge, 'warn', '주의(혈압)');
      }else{
        setBadge(stateBadge, 'ok', '입장 가능');
      }
    }

    // ===== 스캐너 =====
    async function openScanner(){
      scannerLayer.style.display = 'flex';
      scannerLayer.setAttribute('aria-hidden','false');
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},
          audio:false
        });
        qrVideo.srcObject = mediaStream;
        await qrVideo.play();
        startDetectLoop();
      }catch(e){
        alert('카메라를 사용할 수 없습니다. 수동 입력을 사용하세요.\n'+(e.message||e));
        closeScannerPane();
        manualBox.style.display = 'flex';
      }
    }
    function closeScannerPane(){
      scannerLayer.style.display = 'none';
      scannerLayer.setAttribute('aria-hidden','true');
      if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
      scanning = false;
    }
    async function startDetectLoop(){
      scanning = true;
      if('BarcodeDetector' in window){
        try{ detector = new BarcodeDetector({formats:['qr_code']}); }
        catch{ detector = null; }
      }
      if(!detector){
        alert('이 브라우저는 QR 인식을 지원하지 않습니다. 수동 입력을 사용하세요.');
        closeScannerPane();
        manualBox.style.display = 'flex';
        return;
      }
      (async function loop(){
        if(!scanning) return;
        try{
          const codes = await detector.detect(qrVideo);
          if(codes && codes.length){
            const txt = (codes[0].rawValue||'').trim();
            applyResult(txt);
            closeScannerPane();
            return;
          }
        }catch(e){ /* ignore and keep looping */ }
        requestAnimationFrame(loop);
      })();
    }

    // ===== 이벤트 =====
    scanBtn.addEventListener('click', openScanner);
    closeScanner.addEventListener('click', closeScannerPane);
    manualToggle.addEventListener('click', ()=>{
      manualBox.style.display = (manualBox.style.display==='flex' ? 'none' : 'flex');
    });
    applyManual.addEventListener('click', ()=> applyResult(manualCode.value));

    bpMax.addEventListener('input', updateEntryState);
    bpMin.addEventListener('input', updateEntryState);
    alcOver.addEventListener('change', updateEntryState);

    confirmBtn.addEventListener('click', ()=>{
      if(!authorized){ return; }
      // 실제 전송 대신 토스트로 모의
      toastShow('담당자에게 알림을 전송했습니다.');
      // 간단한 로그(콘솔) - 변수명 교정
      console.log('[ALERT]', {
        code: currentCode,
        name: nameText.textContent,
        work: workText.textContent,
        bp_max: bpMax.value,
        bp_min: bpMin.value,
        alcohol_over: alcOver.checked,
        status: stateBadge.textContent
      });
    });

    // 초기 배지
    setBadge(authBadge, '', '대기');
    setBadge(stateBadge, '', '대기');

    // ====== QR 코드 생성 라이브러리(qrcode.js) 인라인 ======
    /*! qrcode.js v1.0.0 | MIT | (c) Kazuhiko Arase / davidshimjs */
    (function(window){function QR8bitByte(data){this.mode=QRMode.MODE_8BIT_BYTE;this.data=data}
    QR8bitByte.prototype={getLength:function(){return this.data.length},write:function(buffer){for(var i=0;i<this.data.length;i++)buffer.put(this.data.charCodeAt(i),8)}};
    var QRMode={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};
    var QRUtil={PATTERN_POSITION_TABLE:function(){return[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,54,82,110,138],[6,30,54,86,118,142],[6,34,62,90,122,154],[6,26,50,74,98,122,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,50,78,106,134,162],[6,32,54,80,108,136,166],[6,26,50,74,98,122,146,170]]},G15:1335,G18:7973,G15_MASK:21522,
    getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>=1}return digit},
    getBCHTypeInfo:function(data){for(var d=data<<10;QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0;)d^=QRUtil.G15<<QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15);return(data<<10|d)^QRUtil.G15_MASK},
    getBCHTypeNumber:function(data){for(var d=data<<12;QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0;)d^=QRUtil.G18<<QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18);return data<<12|d},
    getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE()[typeNumber-1]},
    getMask:function(maskPattern,i,j){switch(maskPattern){case 0:return(i+j)%2==0;case 1:return i%2==0;case 2:return j%3==0;case 3:return(i+j)%3==0;case 4:return(Math.floor(i/2)+Math.floor(j/3))%2==0;case 5:return i*j%2+i*j%3==0;case 6:return(i*j%2+i*j%3)%2==0;case 7:return(i*j%3+(i+j)%2)%2==0;default:throw new Error("bad maskPattern:"+maskPattern)}},
    getErrorCorrectPolynomial:function(errorCorrectLength){var a=new QRPolynomial([1],0);for(var i=0;i<errorCorrectLength;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a},
    getLengthInBits:function(mode,type){if(1<=type&&type<10){switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:return 8;case QRMode.MODE_KANJI:return 8;default:throw new Error("mode:"+mode)}}else if(type<27){switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw new Error("mode:"+mode)}}else{if(!(type<41))throw new Error("type:"+type);switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw new Error("mode:"+mode)}}},
    getLostPoint:function(qr){var moduleCount=qr.getModuleCount();var lostPoint=0;for(var row=0;row<moduleCount;row++)for(var col=0;col<moduleCount;col++){var sameCount=0;var dark=qr.isDark(row,col);for(var r=-1;r<=1;r++)if(!(row+r<0||moduleCount<=row+r))for(var c=-1;c<=1;c++)if(!(col+c<0||moduleCount<=col+c))if(!(r==0&&c==0))dark==qr.isDark(row+r,col+c)&&(sameCount++);sameCount>5&&(lostPoint+=3+sameCount-5)}for(row=0;row<moduleCount-1;row++)for(col=0;col<moduleCount-1;col++){var count=0;qr.isDark(row,col)&&count++;qr.isDark(row+1,col)&&count++;qr.isDark(row,col+1)&&count++;qr.isDark(row+1,col+1)&&count++;(count==0||count==4)&&(lostPoint+=3)}for(row=0;row<moduleCount;row++)for(col=0;col<moduleCount-6;col++)qr.isDark(row,col)&&!qr.isDark(row,col+1)&&qr.isDark(row,col+2)&&qr.isDark(row,col+3)&&qr.isDark(row,col+4)&&!qr.isDark(row,col+5)&&qr.isDark(row,col+6)&&(lostPoint+=40);for(col=0;col<moduleCount;col++)for(row=0;row<moduleCount-6;row++)qr.isDark(row,col)&&!qr.isDark(row+1,col)&&qr.isDark(row+2,col)&&qr.isDark(row+3,col)&&qr.isDark(row+4,col)&&!qr.isDark(row+5,col)&&qr.isDark(row+6,col)&&(lostPoint+=40);var darkCount=0;for(row=0;row<moduleCount;row++)for(col=0;col<moduleCount;col++)qr.isDark(row,col)&&darkCount++;var ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5*10;return lostPoint+=ratio}};
    var QRMath={glog:function(n){if(n<1)throw new Error("glog("+n+")");return QRMath.LOG_TABLE[n]},gexp:function(n){for(;n<0;)n+=255;for(;n>=256;)n-=255;return QRMath.EXP_TABLE[n]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};
    for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];for(i=0;i<256;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
    function QRPolynomial(num,shift){if(num.length==undefined)throw new Error(num.length+"/"+shift);var offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset]}
    QRPolynomial.prototype={get:function(index){return this.num[index]},getLength:function(){return this.num.length},multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(num,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++)num[i]=this.get(i);for(i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)}};
    var QRRSBlock={RS_BLOCK_TABLE:[[],[1,26,19],[1,44,34],[1,70,55],[1,100,80],[1,134,108],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68,2,87,69],[2,98,78,2,99,79],[2,121,97,2,122,98],[2,146,116,2,147,117],[2,86,68,4,87,69],[2,98,78,4,99,79],[2,121,97,4,122,98],[2,146,116,4,147,117],[2,86,68,4,87,69],[2,98,78,4,99,79],[4,121,97],[2,146,116,2,147,117],[4,86,68,2,87,69],[4,98,78,2,99,79],[4,121,97,4,122,98],[2,146,116,4,147,117],[4,86,68,2,87,69],[3,98,78,2,99,79],[4,121,97,2,122,98],[2,146,116,4,147,117],[4,86,68,2,87,69],[2,98,78,4,99,79],[4,121,97,2,122,98]],
    getRSBlocks:function(typeNumber,errorCorrectLevel){var rsBlock=QRRSBlock.RS_BLOCK_TABLE[typeNumber];if(rsBlock==undefined)throw new Error("bad rs block @ typeNumber:"+typeNumber);var list=[];for(var i=0;i<rsBlock.length/3;i++)for(var j=0;j<rsBlock[i*3+0];j++)list.push({totalCount:rsBlock[i*3+1],dataCount:rsBlock[i*3+2]});return list}};
    function QRBitBuffer(){this.buffer=[];this.length=0}
    QRBitBuffer.prototype={get:function(index){return((this.buffer[Math.floor(index/8)]>>>(7-index%8))&1)==1},put:function(num,length){for(var i=0;i<length;i++)this.putBit(((num>>>(length-i-1))&1)==1)},getLengthInBits:function(){return this.length},putBit:function(bit){var bufIndex=Math.floor(this.length/8);this.buffer.length<=bufIndex&&this.buffer.push(0);bit&&(this.buffer[bufIndex]|=(0x80>>>(this.length%8)));this.length++}};
    function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[]}
    QRCodeModel.prototype={addData:function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null},isDark:function(row,col){if(this.modules[row][col]!=null)return this.modules[row][col];throw new Error(row+","+col)},getModuleCount:function(){return this.moduleCount},make:function(){if(this.typeNumber<1){for(var typeNumber=1;typeNumber<40;typeNumber++){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,QRErrorCorrectLevel.M);var buffer=new QRBitBuffer();for(var i=0;i<this.dataList.length;i++)buffer.put(4,4),buffer.put(this.dataList[i].getLength(),QRUtil.getLengthInBits(4,typeNumber)),this.dataList[i].write(buffer);for(buffer.put(0,4);buffer.getLengthInBits()%8!=0;)buffer.put(0,1);for(;buffer.getLengthInBits()<8*(function getTotalDataCount(rsBlocks){var total=0;for(var i=0;i<rsBlocks.length;i++)total+=rsBlocks[i].dataCount;return total}(rsBlocks));)buffer.put(236,8),buffer.getLengthInBits()<8*getTotalDataCount(rsBlocks)&&buffer.put(17,8);this.typeNumber=typeNumber;break}}this.makeImpl(false,this.getBestMaskPattern())},makeImpl:function(test,maskPattern){this.moduleCount=4*this.typeNumber+17;this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++)this.modules[row][col]=null}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.setupTypeInfo(test,maskPattern);this.typeNumber>=7&&this.setupTypeNumber(test);this.dataCache==null&&(this.dataCache=function createData(typeNumber,errorCorrectLevel,dataList){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel);var buffer=new QRBitBuffer();for(var i=0;i<dataList.length;i++)buffer.put(4,4),buffer.put(dataList[i].getLength(),QRUtil.getLengthInBits(4,typeNumber)),dataList[i].write(buffer);for(buffer.put(0,4);buffer.getLengthInBits()%8!=0;)buffer.put(0,1);for(;buffer.getLengthInBits()<8*(function getTotalDataCount(rsBlocks){var total=0;for(var i=0;i<rsBlocks.length;i++)total+=rsBlocks[i].dataCount;return total}(rsBlocks));)buffer.put(236,8),buffer.getLengthInBits()<8*getTotalDataCount(rsBlocks)&&buffer.put(17,8);return (function createBytes(qr,buffer,rsBlocks){var offset=0;var maxDcCount=0;var maxEcCount=0;var dcdata=new Array(rsBlocks.length);var ecdata=new Array(rsBlocks.length);for(var r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount;var ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount);maxEcCount=Math.max(maxEcCount,ecCount);dcdata[r]=new Array(dcCount);for(var i=0;i<dcCount;i++)dcdata[r][i]=buffer.buffer[i+offset];offset+=dcCount;var rsPoly=new QRPolynomial([1],0);for(i=0;i<ecCount;i++)rsPoly=rsPoly.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));var rawPoly=new QRPolynomial(dcdata[r],0);var modPoly=rawPoly.mod(rsPoly);ecdata[r]=new Array(rsPoly.getLength());for(i=0;i<ecdata[r].length;i++)ecdata[r][i]=modPoly.get(i)}var totalCodeCount=0;for(i=0;i<rsBlocks.length;i++)totalCodeCount+=rsBlocks[i].totalCount;var data=new Array(totalCodeCount);var index=0;for(i=0;i<maxDcCount;i++)for(r=0;r<rsBlocks.length;r++)i<dcdata[r].length&&(data[index++]=dcdata[r][i]);for(i=0;i<maxEcCount;i++)for(r=0;r<rsBlocks.length;r++)i<ecdata[r].length&&(data[index++]=ecdata[r][i]);return data})(0,buffer,rsBlocks)}(this.typeNumber,this.errorCorrectLevel,this.dataList));this.mapData(this.dataCache,maskPattern)},
    setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++)if(!(row+r<=-1||this.moduleCount<=row+r))for(var c=-1;c<=7;c++)if(!(col+c<=-1||this.moduleCount<=col+c))this.modules[row+r][col+c]=r>=0&&r<=6&&(c==0||c==6)||c>=0&&c<=6&&(r==0||r==6)||r>=2&&r<=4&&c>=2&&c<=4},
    getBestMaskPattern:function(){var lostPoint=0,pattern=0;for(var i=0;i<8;i++){this.makeImpl(true,i);var lp=QRUtil.getLostPoint(this);(i==0||lp<lostPoint)&&(lostPoint=lp,pattern=i)}return pattern},
    setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++){if(this.modules[r][6]==null)this.modules[r][6]=r%2==0;if(this.modules[6][r]==null)this.modules[6][r]=r%2==0}},
    setupPositionAdjustPattern:function(){var pos=QRUtil.getPatternPosition(this.typeNumber);for(var i=0;i<pos.length;i++)for(var j=0;j<pos.length;j++){var row=pos[i],col=pos[j];if(this.modules[row][col]==null)for(var r=-2;r<=2;r++)for(var c=-2;c<=2;c++)this.modules[row+r][col+c]=r==-2||r==2||c==-2||c==2||r==0&&c==0}},
    setupTypeNumber:function(test){var bits=QRUtil.getBCHTypeNumber(this.typeNumber);for(var i=0;i<18;i++){var mod=(!test&&((bits>>i)&1)==1);this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=mod;this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=mod}},
    setupTypeInfo:function(test,maskPattern){var data=QRErrorCorrectLevel.M<<3|maskPattern;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var mod=!test&&((bits>>i)&1)==1;i<6?this.modules[i][8]=mod:i<8?this.modules[i+1][8]=mod:this.modules[this.moduleCount-15+i][8]=mod}for(i=0;i<15;i++){mod=!test&&((bits>>i)&1)==1;i<8?this.modules[8][this.moduleCount-i-1]=mod:i<9?this.modules[8][15-i-1+1]=mod:this.modules[8][15-i-1]=mod}this.modules[this.moduleCount-8][8]=!test},
    mapData:function(data,maskPattern){var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0;for(var col=this.moduleCount-1;col>0;col-=2){col==6&&col--;for(;;){for(var c=0;c<2;c++)this.modules[row][col-c]==null&&(this.modules[row][col-c]=byteIndex<data.length?((data[byteIndex]>>>bitIndex)&1)==1:false,bitIndex--,bitIndex==-1&&(byteIndex++,bitIndex=7));row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break}}}},
    makeImage:function(size){var count=this.moduleCount,cs=size/count,canvas=document.createElement('canvas');canvas.width=canvas.height=size;var ctx=canvas.getContext('2d');ctx.fillStyle="#fff";ctx.fillRect(0,0,size,size);ctx.fillStyle="#000";for(var r=0;r<count;r++)for(var c=0;c<count;c++)this.isDark(r,c)&&ctx.fillRect(Math.round(c*cs),Math.round(r*cs),Math.ceil(cs),Math.ceil(cs));return canvas}};
    function QRCode(el,opt){this._el=el;this._opt=opt||{}}
    QRCode.prototype.makeCode=function(text){var qr=new QRCodeModel(0,QRErrorCorrectLevel.M);qr.addData(text);qr.make();this._el.innerHTML="";var img=qr.makeImage(this._opt.width||200);img.setAttribute('alt',text);this._el.appendChild(img)};
    window.QRCode=QRCode;})(window);

    // ====== QR 렌더 & 저장 ======
    function renderQRFixed(){
      const target = document.getElementById('qrcode');
      if(!target) return;
      target.innerHTML = '';
      const q = new QRCode(target, { width: 220, height: 220 });
      q.makeCode('TEST1103');
    }
    document.getElementById('saveQrBtn').addEventListener('click', () => {
      const canvas = document.querySelector('#qrcode canvas');
      if(!canvas){ alert('QR이 아직 렌더되지 않았습니다.'); return; }
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'TEST1103-QR.png';
      a.click();
    });
    // 초기 렌더
    renderQRFixed();
  </script>
</body>
</html>
